---
title: "Fric et al. Re-analysis Code"
author: "Vaughn Shirey & Elise Larsen"
date: "Current version 11/19/2020; initiated 3/9/2020"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#start fresh
rm(list=ls())
```
<h2>*</h2>
Begin Analysis

This code chunk sets up the workspace and loads necessary packages.  If phest is not already installed, remove comment from install line.

```{r load packages, message=F}

# load libraries
library(tidyverse)
library(ggplot2)
library(ggExtra)
library(gridExtra)
#library(devtools); install_github("willpearse/phest")
library(phest)
library(readxl)

```
<h2>*</h2>
<h3> Data Import and Formatting</h3>
data.csv file was downloaded from <a href="https://doi.org/10.6084/m9.figshare.9946934">https://doi.org/10.6084/m9.figshare.9946934</a>
(https://figshare.com/articles/Phenology_responses_of_temperate_butterflies_-_Supplementary_data/9946934)

<p>This cvs file contains the occurrence data used in Fric et al. (2020), which they downloaded from gbif. The file includes separate data tables for each dataset, which have been concatenated into one file. These data tables have the same fields but are not formatted as a single data table; individual datasets were all written into one data file, including headers and row indices in each dataset. This first set of code reformats the data & writes formatted data files. </p>


```{r format raw occurrence data table}
all.data <- readLines("fric_supplements/data.csv")

#identify header rows
all.header.rows<-grep("decimalLongitude", all.data)

#check headers for consistency
uniqueheaders<-unique(all.data[all.header.rows])

# 2 versions! -> Get row numbers for "header 1"
header.rows1<-grep(uniqueheaders[1], all.data)
#Get row numbers for "header 2" 
header.rows2<-setdiff(all.header.rows, header.rows1)

#Create row identifiers: 
#0 is a header row, 1 is format 1 data, 2 is format 2 data
j<-rep(0,length(all.data))
for (i in all.header.rows) {
  #set index to the next header if it's not the last header; otherwise set to end of datafile + 1
  if(i<max(all.header.rows)) {
    next_index<-min(all.header.rows[all.header.rows>i])
  }else { next_index<-length(all.data)+1 }

  #for data between header rows, set row index
  j[(i+1):(next_index-1)]<-ifelse(i%in%header.rows1,1,2)
}

#need to add a row index to the header text for new data files
newheader1<-paste('"row.index\",' ,uniqueheaders[1], sep="")
newheader2<-paste('"row.index\",' ,uniqueheaders[2], sep="")

#write data file
formatteddatafile1<-file("data/fric_data_header_1.txt")
writeLines(c(newheader1,all.data[which(j==1)]), formatteddatafile1)
close(formatteddatafile1)

formatteddatafile2<-file("data/fric_data_header_2.txt")
writeLines(c(newheader2,all.data[which(j==2)]), formatteddatafile2)
close(formatteddatafile2)
rm(list=ls())

#read back in the formatted data
data1<-read_csv("data/fric_data_header_1.txt")
data2<-read_csv("data/fric_data_header_2.txt")
paste( nrow(data1), "records in format 1;", nrow(data2), "records in format 2")

occur1<-rbind(data1,data2)
rm(data1,data2)

##Fric et al includes different species names in results tables than found in data table. We change names here to match results tables:
name_changes<-read_csv("data/name_changes.csv")
table(occur1$name[which(occur1$name %in% name_changes$data_name)])

for(namei in 1:nrow(name_changes)) {
  occur1$name[occur1$name==name_changes$data_name[namei]]<-name_changes$results_name[namei]
}

rm(name_changes)

##Fric et al identifies datasets by region (N. America, Europe), but the data file does not include this information. We label data by region using longitude:
## visualize data density by longitude
hist(occur1$decimalLongitude, main="Data density by Longitude") 
#We label everything East of -40 as Europe, the rest as N. America 
occur1<-occur1 %>% 
  mutate(region=ifelse(decimalLongitude>=(-40),"Europe","N. America"))

#Fric et al removed all 1st of month observations and removed one species due to late season nests
occur<-filter(occur1, day!=1, name!="Euphydryas aurinia")

summary(occur)
```
<h2>*</h2>
<h3> Data Exploration</h3>
<p>Data have now been formatted and filtered to mirror the data used by Fric et al. (2020) and stored into the "occur" tibble.</p>
<p>The following code explores some aspects of the data use in the Fric et al. analysis<p>
```{r Data exploration and visualization}
#
#Here we Visualize data density per regression model from Fric et al.
tempoccurplot<-occur %>% group_by(name) %>% tally()
hist(tempoccurplot$n,xlab="# observations/species", main="Frequency of # observations per species")
hist(tempoccurplot$n[tempoccurplot$n<5000],xlab="# observations/species up to 5000", xlim=c(0,5000), main="Detail of observations per species", breaks=c(0:5000*100))
rm(tempoccurplot)

#Tally the number of observations per dataset & calculate how each dataset spans latitude, year, altitude
spans.summary<-occur %>%
  group_by(name, region) %>%
  add_count(name="fric_n") %>% ## n. records
  group_by(name, region, fric_n) %>%
  summarize(lat_span=(max(rndLat, na.rm=T)-min(rndLat, na.rm=T)), 
         year_span=(max(year, na.rm=T)-min(year, na.rm=T)),
         alt_span=round((max(alt, na.rm=T)-min(alt, na.rm=T)),0))

#calculate # latitudes, onsets, terminations, flight curves = 0
endpt.summary<-occur %>%
  group_by(name, region, rndLat) %>%
  # count no. records by latitudinal band
  add_count(name="n_recs") %>% 
  #filter to onset & offset dates and label onset dates and offset dates
  filter(SuccDay==min(SuccDay) | SuccDay==max(SuccDay)) %>% 
  mutate(onset=ifelse(SuccDay==min(SuccDay),1,0),    term=ifelse(SuccDay==max(SuccDay),1,0)) %>%
  group_by(name, region) %>%
  #create summary statistics by species & region
  summarize(n_lat=length(unique(rndLat)), n_onset=sum(onset), n_term=sum(term), n_flightcurve0s=sum(n_recs==1) )

#combine summary tables
fric.data.summary<-merge(spans.summary, endpt.summary, by=intersect(names(spans.summary), names(endpt.summary)))
rm(spans.summary)
summary(fric.data.summary)

```
<h2>*</h2>
<h3>Explore data by altitude & latitude</h3> 
This code chunk explores the spatiotemporal representation in the occur dataset.
<h3> Create Figure 1: Occurrences by altitude & latitude </h3>
This code outputs Larsen & Shirey Figure 1, which uses the 4 species presented in Fric et al. Figure 1, to demonstrate the spatiotemporal biases as well as the prevalence of flight periods with a duration of 0 days.

```{r exploring -altitude + latitude- creating figure 1}
summary(occur$alt)
hist(occur$alt)
summary(occur$decimalLatitude)
hist(occur$decimalLatitude)
##Create Figure 1
#species list
fig1sp<-c("Agriades glandon","Glaucopsyche lygdamus","Hesperia comma","Parnassius smintheus")

#Filter data to these species
fig1data<-occur %>%
  filter(name %in% fig1sp)  

#Get onset & termination dates (SuccDay)
f1.pheno.data<-fig1data %>%
  group_by(name, region, rndLat) %>%
  mutate(onset=min(SuccDay), term=max(SuccDay), fp=term-onset, singles=ifelse(length(SuccDay)==1,1,0))

f1.pheno.data2<-f1.pheno.data %>%
  filter(SuccDay==onset | SuccDay==term)

#A list to store plot panels
tempplot<-list()
fig1panels<-list()

tags<-c("A","B","C","D")

#Create Panels
for(i in 1:2) {
  #paneltitle<-paste(fig1sp[i],"N. America")
  tempplot[[i]] <- ggplot(filter(f1.pheno.data, name==fig1sp[i], region=="N. America"), aes(x=rndLat, y=SuccDay, color=as.factor(singles))) +
    theme_bw() + 
    theme(legend.position="none", plot.margin = margin(1,1,1,1, "in")) + 
    geom_segment(data=filter(f1.pheno.data2, name==fig1sp[i], region=="N. America"), aes(x=rndLat, y=onset, xend=rndLat, yend=term)) + 
    geom_point(aes(color=as.factor(singles))) +
    scale_color_manual(values=c("black","red")) + 
    xlim(min(f1.pheno.data$rndLat),max(f1.pheno.data$rndLat)) + ylim(min(f1.pheno.data$SuccDay),max(f1.pheno.data$SuccDay)) +
    labs(x="Latitudinal Band", y="Day of Year (DOY)", title="") + geom_text(x=min(f1.pheno.data$rndLat), y=max(f1.pheno.data$SuccDay), label=tags[i])
  
  # with marginal histograms
  fig1panels[[i]] <- ggMarginal(tempplot[[i]], type="histogram") 
  }


i<-3 #H. comma panel in Fric et al. is from Europe
#paneltitle<-paste(fig1sp[i],"Europe")
  tempplot[[i]] <- ggplot(filter(f1.pheno.data, name==fig1sp[i], region=="Europe"), aes(x=rndLat, y=SuccDay, color=as.factor(singles))) +
    theme_bw() + 
    theme(legend.position="none", plot.margin = margin(1,1,1,1, "in")) + 
    geom_segment(data=filter(f1.pheno.data2, name==fig1sp[i], region=="Europe"), aes(x=rndLat, y=onset, xend=rndLat, yend=term)) + 
    geom_point(aes(color=as.factor(singles))) +  
    scale_color_manual(values=c("black","red")) +
    xlim(min(f1.pheno.data$rndLat),max(f1.pheno.data$rndLat)) + ylim(min(f1.pheno.data$SuccDay),max(f1.pheno.data$SuccDay)) +
    labs(x="Latitudinal Band", y="Day of Year (DOY)", title="") + geom_text(x=min(f1.pheno.data$rndLat), y=max(f1.pheno.data$SuccDay), label=tags[i])
  
  # with marginal histogram
  fig1panels[[i]] <- ggMarginal(tempplot[[i]], type="histogram") 
  
##### Figure 1d  2020-07-29 update uses YEAR and DAY to mirror Fric et al.
i<-4
#paneltitle<-paste(fig1sp[i],"N. America")
tempplot[[i]]<- ggplot(filter(f1.pheno.data, name==fig1sp[i], region=="N. America"), aes(x=year, y=SuccDay, fill=decimalLatitude)) +
  geom_point(shape=3) + 
  theme_bw() + 
  theme(legend.position="none", plot.margin = margin(1,1,1,1, "in")) + 
  geom_point(data=filter(f1.pheno.data2, name==fig1sp[i], region=="N. America"), aes(x=year, y=onset, fill=decimalLatitude), shape=24) + 
  geom_point(data=filter(f1.pheno.data, name==fig1sp[i], region=="N. America"), aes(x=year, y=term, fill=decimalLatitude), shape=25) + 
  scale_fill_gradient(low="azure1", high="black") + 
  geom_point(data=filter(f1.pheno.data2, name==fig1sp[i], region=="N. America", singles==1), aes(x=year, y=SuccDay), color="red", shape=16) +
  xlim(min(f1.pheno.data$year),max(f1.pheno.data$year)) + ylim(min(f1.pheno.data$SuccDay),max(f1.pheno.data$SuccDay)) +
  labs(x="Year", y="Day of Year (DOY)", title="") + geom_text(x=min(f1.pheno.data$year), y=max(f1.pheno.data$SuccDay), label=tags[i])


# with marginal histogram
fig1panels[[i]]  <- ggMarginal(tempplot[[i]], type="histogram")

grid.arrange(grobs=fig1panels[c(1:4)], nrow=2, ncol=2, top="Visualization of data used in Fric et al. for \n (A) Agriades glandon      (B)Glaucopsyche lygdamus \n (C)Hesperia comma      (D)Parnassius smintheus")


#Used to create figure 1 pdf
#pdf_filename<-("outputs/Larsen&Shirey2020_FinalFig1.pdf")
#ggsave(pdf_filename, arrangeGrob(grobs=fig1panels[ds1], nrow=2, ncol=2), width=6, height=6, units="in", scale=1,dpi=600)

#rm(f1.pheno.data,f1.pheno.data2, fig1data,fig1panels,fig1sp, ds1,tempplot, tags, i)

```
<h2>*</h2>
<h3>Data curation</h3> 
<p>Data have now been formatted, identified by region, and summarized.</p>
<p>The following code chunk applies the filters used in the Larsen & Shirey reanalysis and calculates summary data density statistics for all species present in Fric's results to output to Supplemental Table 1.</p>

<p> Our reanalysis excludes datasets along two axes - data density, and voltinism. This code examines data along the data density axis. Unlike Fric et al., we include first day of the month records. We curate raw occurrence data with the following filters prior to estimating phenometrics:</p> 
<ul>
<li>1 - remove Euphydryas aurinia as Fric et al. did
<li>2 - altitude in [0m,500m]</li>
<li>3 - month in March - November</li>
<li>4 - 10 or more records when data is grouped by species, region, year, and latitudinal band </li>
</ul>
```{r data density for 105 datasets}
#Summarize data availability for Larsen & Shirey re-analysis
#Now, filter data for altitude & for cases with 10 or more records by species-region-year-latitude
new.data.summary<-occur1 %>%
  filter(between(alt,0,500), name!="Euphydryas aurinia", month %in% c(3:11)) %>%
  # calculate data availability by species, region, latitude & year
  group_by(name, region, rndLat, year) %>% 
  add_count(name="group_n") %>% ## n. observations per group
  filter(group_n>=10) %>% ### filter by 10 or more observations in group
  # calculate reanalysis statistics by species & region
  group_by(name, region) %>%
  add_count(name="curated_n_obs") %>%  
  group_by(name, region, curated_n_obs) %>%
  #calculate summary statistics applying data filters
  summarize(curated_n_lat=length(unique(rndLat)),  curated_n_fcurve=length(unique(paste(rndLat,year))), 
            curated_lat_span=(max(rndLat, na.rm=T)-min(rndLat, na.rm=T)), 
            curated_year_span=(max(year, na.rm=T)-min(year, na.rm=T)),
            curated_alt_span=round((max(alt, na.rm=T)-min(alt, na.rm=T)),0))

#combine summary tables
supptable1<-merge(fric.data.summary, new.data.summary, by=intersect(names(fric.data.summary), names(new.data.summary)), all.x=T)
head(supptable1)
summary(supptable1)

#output summary table to csv file
#write_csv(supptable1, "Larsen&Shirey_stats_supp_table1.csv")
rm(fric.data.summary, new.data.summary, endpt.summary)
```
<h2>*</h2>
<h3>Data curation 2</h3> 
<p>This code filters occurrence data for reanalysis by voltinism and data density, and visualizes some differences between datasets curated for the original analysis and this reanalysis. We only include datasets with sufficient data for calculating phenometrics at 3 or more distinct latitudinal bands, so that a linear model can be applied.</p>

```{r voltinism and reanalysis data filter}
#FILTER DATA BY VOLTINISM

#get species list without evidence of multiple generations
#Euphydryas aurinia is not included in the voltinism file
voltindata<-read_csv("data/voltinism.csv")
voltindata<-na.omit(voltindata[,c(1:8)])
voltindata<-voltindata %>% select(name=name_resultsfile,region,Voltinism)
multi<-c("Bivoltine", "Multivoltine","Sometimes bivoltine","Possible bivoltinism in some subsp.","Unconfirmed reports of second brood")
univoltine<-filter(voltindata, !Voltinism %in% multi)
rm(voltindata, multi)

#filter occurrence dataset to these species
reanalysis.data<-merge(occur1, univoltine, by=intersect(names(occur1),names(univoltine)))

#filter data by altitude and data density
reanalysis.data<-reanalysis.data %>%
  filter(between(alt,0,500), month %in% c(3:11)) %>%
  # calculate data availability by species, region, latitude & year
  group_by(name, region, rndLat, year) %>% 
  add_count(name="group_n") %>% ## n. observations per group
  filter(group_n>=10) %>% #only groups with at least 10 observations
  group_by(name, region) %>% #group by "dataset"
  mutate(nlat=length(unique(rndLat))) %>% #count how many distinct latitudinal bands included
  filter(nlat>=3) # need at least 3 latitudinal bands

#visualize some differences
plotcompar<-list()
plotcompar[[1]]<-ggplot(data=occur, aes(x=region, y=alt) ) +
  geom_boxplot(outlier.colour="red", outlier.shape=16, outlier.size=2, notch=FALSE) + ggtitle(label="Original dataset altitudes")

plotcompar[[2]]<-ggplot(data=reanalysis.data, aes(x=region, y=alt) ) +
  geom_boxplot(outlier.colour="red", outlier.shape=16, outlier.size=2, notch=FALSE) + ggtitle(label="Reanalysis dataset altitudes") + ylim(min(occur$alt),max(occur$alt))

plotcompar[[3]]<-ggplot(data=occur, aes(x=region, y=rndLat) ) +
  geom_boxplot(outlier.colour="red", outlier.shape=16, outlier.size=2, notch=FALSE) + ggtitle(label="Original dataset latitudes")

plotcompar[[4]]<-ggplot(data=reanalysis.data, aes(x=region, y=rndLat) ) +
  geom_boxplot(outlier.colour="red", outlier.shape=16, outlier.size=2, notch=FALSE) + ggtitle(label="Reanalysis dataset latitudes") + ylim(min(occur$rndLat), max(occur$rndLat))

plotcompar[[5]]<-ggplot(data=filter(occur, !is.na(year)), aes(x=region, y=year) ) +
  geom_boxplot(outlier.colour="red", outlier.shape=16, outlier.size=2, notch=FALSE) + ggtitle(label="Original dataset years")

plotcompar[[6]]<-ggplot(data=reanalysis.data, aes(x=region, y=year) ) +
  geom_boxplot(outlier.colour="red", outlier.shape=16, outlier.size=2, notch=FALSE) + ggtitle(label="Reanalysis dataset years") + ylim(min(occur$year, na.rm=T), max(occur$year, na.rm=T))

grid.arrange(grobs=plotcompar[c(1:6)], nrow=3)

```
<h2>*</h2>
<h3>Estimate phenometrics using phest</h3> 
<p>This chunk of code estimates onset and offset phenometrics by species-region-year-latitudinal_band using curated data. </p>
<p>We use the phest package to estimate onset and offset of flight periods based on occurrence data, when at least 10 observations exist for a species-region-year-latitudinal_band unit. The phest package applies a weibull distribution. Please note that this chunk does take a few minutes to run. Also, warnings are automatically generated by "phest" when a correction is applied to the phenometric estimate. Additionally, "phest" throws a warning for CI estimation. We have explored these warnings and don't believe that there is any problem continuing with the estimates produced; therefore we have suppressed the warning messages here.</p>

```{r estimate phenometrics for reanalysis}
rm(plotcompar)

#For each species & region, calculate phenometrics
datasets<-reanalysis.data %>% group_by(name, region) %>% tally()
pheno.est<-data.frame(name=character(0),region=character(0),year=integer(0),rndLat=integer(0),onset.est=numeric(0),onset.low=numeric(0),onset.high=numeric(0),offset.est=numeric(0),offset.low=numeric(0),offset.high=numeric(0))
  
for(rowi in 1:nrow(datasets)){ # for each unique dataset
  namei<-datasets$name[rowi]
  regi<-datasets$region[rowi]
  index <- 1 # create/reset an indexer
  pheno.estimates <- list() # create/refresh a blank list per group
  rowi.data<-filter(reanalysis.data, name==namei, region==regi)
  for(yr in unique(rowi.data$year)){ # and each unique year
    for(lat in unique(rowi.data$rndLat)){ # and each unique latitude
      temp <- filter(rowi.data, rndLat==lat, year==yr) # filter the occurrence data for each group
      
      if(nrow(temp) > 9){ # if there are at least 10 occurrences, then...
        estimates <- c(namei, regi, yr, lat, nrow(temp), 
                       suppressWarnings(weib.limit(temp$SuccDay, upper=FALSE, alpha=0.05)), 
                       suppressWarnings(weib.limit(temp$SuccDay, upper=TRUE, alpha=0.05))) # calculate estimates for the group: onset, offset
        pheno.estimates[[index]] <- estimates # shuttle those into a list
        index <- index+1
      } #end if enough occurrences
    } #end lat
  } #end yr
  df <- data.frame(matrix(unlist(pheno.estimates), nrow=length(pheno.estimates), byrow=TRUE),stringsAsFactors=FALSE)
  names(df)<-c("name","region","year","rndLat","n","onset.est","onset.low","onset.high","offset.est","offset.low","offset.high")
  pheno.est<-rbind(pheno.est, df)
}
for(coli in 3:11) {
  pheno.est[,coli]<-as.numeric(pheno.est[,coli])
}

#Format & store data
pheno.data<-pheno.est %>%
  mutate(unit=paste(name, rndLat, year,sep="-")) %>%
  select(unit,onset.est,offset.est,name,region,rndLat,year,n) %>%
  mutate(onset=round(onset.est,0),term=round(offset.est,0))
pheno.data<-na.omit(pheno.data)
#Weibull estimator doesn't bound so
#We bounded all onset & termination metrics y [60,330], limiting flight periods to March - November
pheno.data$onset[pheno.data$onset<60]<-60
pheno.data$term[pheno.data$term>330]<-330

#save(pheno.data, file="data/phenometrics.RData")
```
<h2>*</h2>
<h3>Statistical models for phenometrics</h3>
<p>This code uses estimated onset and offset phenometrics in linear models to examine phenological patterns with latitude and year. Other statistical models may be more appropriate for a de novo analysis, but here we want our statistical model to parallel the Fric et al. model in intention, but using multiple regression instead of residual regression.</p>

```{r statistical reanalysis of phenological patterns}
#If we want to skip phest and phenometric estimation:
#load("data/phenometrics.RData")

datasets<-pheno.data %>%
  group_by(name, region) %>%
  tally()
pheno.data<-na.omit(pheno.data)
#Loop through datasets, run model for phenology by species & region, and store LM parameters
onsetpheno<-list()
termpheno<-list()
onset1<-NULL
term1<-NULL
axes<-NULL

for(rowi in 1:nrow(datasets)) {
  pheno.rowi<-pheno.data %>%
    filter(name==datasets$name[rowi], region==datasets$region[rowi]) 
#estimate model params for onset
  onset.lm<-summary(lm(onset~rndLat+year, data=pheno.rowi))$coefficients #estimate model params for termination
  term.lm<-summary(lm(term~rndLat+year, data=pheno.rowi))$coefficients   
#store 
  onsetpheno[[rowi]]<-onset.lm  
  termpheno[[rowi]]<-term.lm  

    #onset
  temponset<-matrix(unlist(onset.lm[c(2:3),]), ncol=4, byrow=F)
  onset1<-rbind(onset1, temponset)
  axes<-c(axes,row.names(onset.lm)[c(2:3)])
#termination
  tempterm<-matrix(unlist(term.lm[c(2:3),]), ncol=4, byrow=F)
  term1<-rbind(term1, tempterm)
  rm(pheno.rowi,onset.lm,term.lm,temponset,tempterm)
  }

#Create results dataframes: onset
onset1<-as.data.frame(onset1)
colnames(onset1)<-c("param.est","param.se","param.t","param.p")
onset1$param<-axes
onset1$metric<-"onset"
onset1$name<-rep(datasets$name, each=2)
onset1$region<-rep(datasets$region, each=2)
onset1$n<-rep(datasets$n, each=2)

#Create results dataframes: termination
term1<-as.data.frame(term1)
colnames(term1)<-c("param.est","param.se","param.t","param.p")
term1$param<-axes
term1$metric<-"termination"
term1$name<-rep(datasets$name, each=2)
term1$region<-rep(datasets$region, each=2)
term1$n<-rep(datasets$n, each=2)


result<-as.data.frame(rbind(onset1, term1))
result<-result %>%
  mutate(response=ifelse(param.p<0.05,ifelse(param.est>0,1,-1),0))

#Plot coefficients colored by response sign
coef.plot1<-ggplot(data=filter(result, param=="rndLat"), aes(x=as.factor(metric), y=param.est)) + 
  geom_boxplot() + 
  geom_jitter(data=filter(result, param=="rndLat"),  aes(x=as.factor(metric), y=param.est, color=as.factor(response)), width=0.2, height=0, shape=17) +
  labs(x="", y="Latitude coefficient") + 
  scale_color_manual(values=c("blue", "darkgray", "darkgreen")) +
  theme_light() + theme(legend.position = "none")
coef.plot1
#The positive and neutral slopes of onset ~ latitude indicate that species typically emerge either at similar or later times of year at higher latitudes. This along with the varied slopes of termination ~ latitude indicate that most flight periods may generally shift later and/or have shorter duration at higher latitudes.

#NOT in manuscript but exploratory: Using only coefficients and significance without confidence intervals, what phenological patterns are present?
slopediff<-NULL
for(spi in unique(result$name)) {
  d.start<-ifelse(filter(result,param=="rndLat",name==spi,metric=="onset")$response>0,"later","same")
  d.duration<- ifelse(filter(term1,param=="rndLat",name==spi)$param.est-filter(onset1,param=="rndLat",name==spi)$param.est<0,"shorter",ifelse(filter(term1,param=="rndLat",name==spi)$param.est-filter(onset1,param=="rndLat",name==spi)$param.est>0,"longer","same"))
  slopediff<-c(slopediff, paste(d.start,d.duration,sep="."))
}
table(slopediff)
```
<h2>*</h2>
<h3>Compare statistical results to Fric et al.</h3>
<p>This code uses model outputs and compares them to the results of the Fric et al. analysis. It outputs Figure 2.</p>
```{r result comparison  & figure 2, fig.height = 6, fig.width = 10, fig.align = "center"}
##Results and visualizations

fric.results.lat<-read_excel("data/Fric_results.xlsx", sheet="models")
datasets$set<-paste(datasets$name,datasets$region,sep="-")
fric.results<-fric.results.lat %>%
  mutate(region=ifelse(region=="NA","N. America","Europe")) %>%
  mutate(reanalyzed=ifelse(paste(name,region,sep="-") %in% datasets$set,1,0))
#Model 1 = Fric Direct regression, all species
fric1<-fric.results %>%
  filter(model=="~latitude") %>%
  select(name,region,onset_coef, onset_response, term_coef, term_response) %>%
  mutate(modelnum=1) 

#Model 3 = Fric Direct regression, reanalyzed species
fric3<-fric.results %>%
  filter(model=="~latitude", reanalyzed==1) %>%
  select(name,region,onset_coef, onset_response, term_coef, term_response) %>%
  mutate(modelnum=3) 

#Model 2 = Fric residual regression, all species
fric2<-fric.results %>%
  filter(model=="~latitude|altitude+year") %>%
  select(name,region,onset_coef, onset_response, term_coef, term_response) %>%
  mutate(modelnum=2) 

#Model 4 = Fric residual regression, reanalyzed species
fric4<-fric.results %>%
  filter(model=="~latitude|altitude+year", reanalyzed==1) %>%
  select(name,region,onset_coef, onset_response, term_coef, term_response) %>%
  mutate(modelnum=4) 

#Model 5 = Reanalysis multiple regression
temp<-pivot_wider(filter(result, param=="rndLat"), id_cols =c(name, region),names_from=metric,values_from=c(param.est,param.p, response) )

result5<-temp %>%
  select(name, region, onset_coef=param.est_onset, onset_response=response_onset,term_coef=param.est_termination,term_response=response_termination) %>%
  mutate(modelnum=5)
rm(temp,fric.results.lat)

#Combine all results into 1 data frame
result.compar<-as.data.frame(rbind(fric1,fric2,fric3,fric4,result5))
result.compar$modelnum<-as.factor(result.compar$modelnum)
result.compar$s1<-1
##Create Figure 2
colorscheme<-c("blue", "darkgray", "darkgreen")
modelnames<-c("AllFric1","AllFric2","Fric1","Fric2","Reanalysis")
#Panels A, D: compare coefficients
#Panel A: Onset coefficients
onset.sp<-ggplot(data=filter(result.compar, as.numeric(modelnum)>3), aes(x=name, y=onset_coef, shape=as.factor(modelnum), fill=as.factor(onset_response))) + 
  geom_point(color="black") +
  scale_shape_manual(values=c(22,21)) +
  scale_fill_manual(values=c("white","black")) + 
  geom_hline(yintercept=0) + 
  scale_y_continuous(breaks=seq(-8,8,2)) + 
  labs(x="", y="Latitude coefficient") + coord_flip() + 
  theme_light() + theme(legend.position = "none", axis.text=element_text(size=8))
#onset.sp
#Panel D: Termination coefficients
term.sp<-ggplot(data=filter(result.compar, as.numeric(modelnum)>3), aes(x=name, y=term_coef, shape=as.factor(modelnum), fill=as.factor(term_response))) + 
  geom_point(color="black") +
  scale_shape_manual(values=c(22,21)) +
  scale_fill_manual(values=c("black","white","black")) + 
  geom_hline(yintercept=0) + 
  scale_y_continuous(breaks=seq(-8,8,2)) + 
  labs(x="", y="Latitude coefficient") + coord_flip() + 
  theme_light() + theme(legend.position = "none", axis.text=element_text(size=8))
#term.sp

#Panels B, E: response boxplots
#Pandel B: Onset
onset.c<-ggplot(data=result.compar, aes(x=modelnum, y=onset_coef)) + 
  geom_boxplot() + 
  geom_jitter(data=filter(result.compar),  aes(x=modelnum, y=onset_coef, color=as.factor(onset_response)), width=0.2, height=0, shape=17) +
  labs(x="", y="Onset ~ Latitude coefficient") + 
  scale_color_manual(values=colorscheme) +
  theme_light() + theme(legend.position = "none") + 
  scale_x_discrete(breaks=c(1:5),labels=modelnames)
onset.c
#Panel D: termination
term.c<-ggplot(data=result.compar, aes(x=modelnum, y=term_coef)) + 
  geom_boxplot() + 
  geom_jitter(data=filter(result.compar),  aes(x=modelnum, y=term_coef, color=as.factor(term_response)), width=0.2, height=0, shape=17) +
  labs(x="", y="Termination ~ Latitude coefficient") + 
  scale_color_manual(values=colorscheme) +
  theme_light() + theme(legend.position = "none") + 
  scale_x_discrete(breaks=c(1:5),labels=modelnames)

#Panels C, F: stacked barplots
#Panel c: Onset responses
onset.st<-ggplot(data=result.compar, aes(x=modelnum, y=s1, fill=as.factor(onset_response))) + 
  geom_bar(position=position_stack(reverse=T), stat="identity")  + 
  scale_fill_manual(values=colorscheme) +
  labs(x="", y="# species by response sign") + theme_light() + theme(legend.position = "none") + 
  scale_x_discrete(breaks=c(1:5),labels=modelnames)
#Panel F: Termination responses
term.st<-ggplot(data=result.compar, aes(x=modelnum, y=s1, fill=as.factor(term_response))) + 
  geom_bar(position=position_stack(reverse=T), stat="identity") + 
  scale_fill_manual(values=colorscheme) +
  theme_light() + 
  labs(x="", y="# species by response sign")+ theme(legend.position = "none")+ 
  scale_x_discrete(breaks=c(1:5),labels=modelnames)
term.st


##Combine panels into Figure 2:
p1<-onset.sp+labs(tag="A")
p2<-onset.c+labs(tag="B")
p3<-onset.st+labs(tag="C")
p4<-term.sp+labs(tag="D")
p5<-term.c+labs(tag="E")
p6<-term.st+labs(tag="F")

#pdf_filename<-("output/LarsenShirey2020_Fig2.pdf")
fig2<-grid.arrange(ncol=3, grobs=list(p1, p2, p3, p4, p5, p6), top="\n\n", bottom="\n\n", left="\n\n", right="\n\n", width=10, height=5) 
#ggsave(pdf_filename, arrangeGrob(fig2, nrow=1), width=10, height=5, scale=1.5, dpi=600,units="in")
fig2
```
<h2>*</h2>
<h3>Create statistics for results table (Supplemental Table 2)</h3>
<p>This code outputs a results table that is a partial Supplemental Table 2 - it is currently missing the 'year' analyses from Fric et al., as our focus is on the latitudinal patterns.</p>
```{r outputing statistical results table}
fric.table<-fric.results %>%
  filter(reanalyzed==1) %>%
  select(name, region, model, onset_response, onset_p, onset_coef, term_response, term_p=term_p_mean, term_coef) 

fric.onset<-fric.table %>%
  select(name:model, Fric_singleRegression_sign=onset_response, Fric_singleRegression_p=onset_p,Fric_singleRegression_coef=onset_coef,) %>%
  mutate(phenometric="onset")
fric.term<-fric.table %>%
  select(name:model, Fric_singleRegression_sign=term_response, Fric_singleRegression_p=term_p,Fric_singleRegression_coef=term_coef,) %>%
  mutate(phenometric="termination")
fric.table<-rbind(fric.onset, fric.term)
fric.table<-fric.table %>%
  mutate(indep.variable=ifelse(model=="~latitude","latitude",ifelse(model=="~year","year",0)) ) 
  
fric1<-filter(fric.table,indep.variable %in% c("latitude","year"))
fric2<-fric.table %>%
  filter(!indep.variable %in% c("latitude","year")) %>%
  select(name, region,phenometricFric_resid.regress_sign=Fric_singleRegression_sign, Fric_resid.regress_p=Fric_singleRegression_p,Fric_resid.regress_coef=Fric_singleRegression_coef) %>%
  mutate(indep.variable="latitude")

reanalysis.table<-result %>%
  select(name, region, phenometric=metric, param, response, param.p, param.est) %>%
  mutate(indep.variable=ifelse(param=="year","year","latitude"))%>%
  select(name, region, phenometric, indep.variable, Reanalysis_sign=response, Reanalysis_p=param.p, Reanalysis_coef=param.est)

supptable2<-merge(reanalysis.table,fric1[,c(1,2,4:8)], by=intersect(names(reanalysis.table),names(fric1[,c(1,2,4:8)])))  

supptable2<-merge(supptable2,fric2,by=intersect(names(supptable2),names(fric2)), all.x=T)  
summary(supptable2)
##This partial supplementary table 2 does not include the residual regression year results, which would fill in the NA's in the table.
#write.csv(supptable2,file="output/supp_table2_part.csv")

```
<h2>*</h2>
<h3>Create panels for Supplemental Figure 1</h3>
<p>In this code chunk, we previously used lm.model$call references in geom_smooth, which created a string of outputs showing the calls. The current simple lm still includes geom_smooth output text, which would be nice to suppress if we can figure that out. </p>

```{r supplemental figure 1 panels, echo=F, warning=F, message=F}

#################### SUPPLEMENTAL FIGURE 1 


## PLOT PARAMETERS 
m0 <- 0.5 #plot margins
negslope <- "blue"
posslope <- "darkgreen"
flatslope <- "black"
singles <- "red"

#Filter data to reanalyzed datasets and use Fric et al. method of defining Onset & Termination
#Keep all data but label records used as onset and offset
fric.data<-occur %>%
  filter(paste(name, region,sep="-")%in%datasets$set) %>%
  group_by(name,region, rndLat) %>%
  mutate(onset=min(SuccDay), term=max(SuccDay)) %>%
  add_tally() %>%
  mutate(Group=ifelse(n==1,1,0)) #, onsetobs=ifelse(onset==SuccDay,1,0), termobs=ifelse(term==SuccDay,1,0)) 

#################### SUPPLEMENTAL FIGURE 2 COL 1-2: 
##Col 1 - Fric analysis: DOY ~ latitude 
##Col 2 - Fric analysis: residuals(residuals(DOY~year)~altitude) ~ latitude

sup1a<-list()
sup1b<-list()
for(rowi in 1:nrow(datasets)) {
    #Filter Fric data
    speciesdata<-  filter(fric.data, name==datasets$name[rowi], region==datasets$region[rowi])
    onsetdata<-  filter(speciesdata, onset==SuccDay)
    termdata<-  filter(speciesdata, term==SuccDay)
    #Column 1
    #Fric onset parameters
    fric.onset.lm<-lm(onset~rndLat, data=onsetdata)
    fric.term.lm<-lm(term~rndLat, data=termdata)
    fric.onset.coef<-summary(fric.onset.lm)$coefficients
    fric.term.coef<-summary(fric.term.lm)$coefficients
    
    #Column 2
    #regression of residuals for onset
    fric.onset.alt<-lm(onset~alt, data=onsetdata)
    onsetdata$alt.resid<-summary(fric.onset.alt)$residuals
    fric.onset.yralt<-lm(alt.resid~year, data=onsetdata)
    onsetdata$yralt.resid<-summary(fric.onset.yralt)$residuals
    fric.onset.resid<-lm(yralt.resid~rndLat, data=onsetdata)
    fric.onset.resid.coef<-summary(fric.onset.resid)$coefficients
    
    #regression of residuals for termination
    fric.term.alt<-lm(term~alt, data=termdata)
    termdata$alt.resid<-summary(fric.term.alt)$residuals
    fric.term.yralt<-lm(alt.resid~year, data=termdata)
    #We add 200 here because its the easiest way *FOR US* to space out the onset & termination lines in column 2
    termdata$yralt.resid<-summary(fric.term.yralt)$residuals+ 200
    fric.term.resid<-lm(yralt.resid~rndLat, data=termdata)
    fric.term.resid.coef<-summary(fric.term.resid)$coefficients
    
    #set parameters for Column 1 based on LM results 
    onsetline<-ifelse(fric.onset.coef[2,4]<0.05,"dashed","dotted")
    onsetcolor<-ifelse(fric.onset.coef[2,4]<0.05,ifelse(fric.onset.coef[2,1]>0,posslope,negslope),flatslope)

    termline<-ifelse(fric.term.coef[2,4]<0.05,"dashed","dotted")
    termcolor<-ifelse(fric.term.coef[2,4]<0.05,ifelse(fric.term.coef[2,1]>0,posslope,negslope),flatslope)

    # For 2 species, our LM here does not produce results consistent with Fric et al. so we manually change the line parameters. there is probably ba more elegant way we could incorporate this into code by comparing lm results to fric results table
    if(rowi==16) {onsetcolor <- negslope; onsetline <- "dashed"}
    if(rowi==20) {termcolor <- posslope; termline <- "dashed"}
    
    mytitle<-paste(datasets$name[rowi])
    #set xmin to 35, unless there are data south of that latitude
    xmin<-ifelse(min(speciesdata$rndLat)<35,min(speciesdata$rndLat),35)
    #Set top and bottom margins for odd (top of page) and even (bottom of page) rows
    t1<-ifelse((rowi %% 2) == 0,0.5,2.8)
    b1<-ifelse((rowi %% 2) == 0,2.8,0.5)
    #Create column 1 plot
    sup1a[[rowi]] <- ggplot(speciesdata, aes(x=rndLat, y=SuccDay, color=as.factor(Group))) +
      geom_point(aes(color=as.factor(Group)), shape=3) +
      geom_point(data=onsetdata, aes(x=rndLat, y=SuccDay, color=as.factor(Group))) + 
      geom_point(data=termdata, aes(x=rndLat, y=SuccDay, color=as.factor(Group))) + 
      geom_segment(data=filter(speciesdata, onset==SuccDay | term==SuccDay), aes(x=rndLat, y=onset, xend=rndLat, yend=term)) + 
      geom_smooth(data=onsetdata, aes(x=rndLat,y=SuccDay),  method="lm", linetype=onsetline, color=onsetcolor, fill=onsetcolor) + 
      geom_smooth(data=termdata, aes(x=rndLat,y=SuccDay), method="lm", linetype=termline, color=termcolor, fill=termcolor) + 
      scale_color_manual(values=c("black","red")) +
      xlim(xmin,max(fric.data$rndLat)) + ylim(min(fric.data$SuccDay),max(fric.data$SuccDay)) +
      theme_light() +   theme(legend.position="none") + 
      theme(plot.title = element_text(size=11,face = "italic"), axis.title=element_text(size=10), plot.margin = margin(t1, m0, b1, 2, "cm")) +
      labs(x="Latitudinal Band", y="Day of Year (DOY)", title=mytitle)
    rm(onsetline,onsetcolor,termline,termcolor)
    
    #Supplemental Figure 1 Column 2
    #set parameters for Column 2 based on LM results 
    onsetline<-ifelse(fric.onset.resid.coef[2,4]<0.05,"dashed","dotted")
    onsetcolor<-ifelse(fric.onset.resid.coef[2,4]<0.05,ifelse(fric.onset.resid.coef[2,1]>0,posslope,negslope),flatslope)

    termline<-ifelse(fric.term.resid.coef[2,4]<0.05,"dashed","dotted")
    termcolor<-ifelse(fric.term.resid.coef[2,4]<0.05,ifelse(fric.term.resid.coef[2,1]>0,posslope,negslope),flatslope)
    #Set top and bottom margins for odd (top of page) and even (bottom of page) rows
    t2<-ifelse((rowi %% 2) == 0,0.5,2.8)
    b2<-ifelse((rowi %% 2) == 0,2.8,0.5)
    #Create column 2 plot
    #sanity check: onset alone
     test<-ggplot(onsetdata, aes(x=rndLat, y=yralt.resid)) +
      geom_point(data=onsetdata,aes(x=rndLat, y=yralt.resid, color=as.factor(Group)), shape=24) +
      geom_point(data=filter(onsetdata, Group==1),aes(x=rndLat, y=yralt.resid, color=as.factor(Group)), fill="red",shape=24) +
      #geom_point(data=termdata,aes(x=rndLat, y=yralt.resid, color=as.factor(Group), fill=as.factor(Group)), shape=25) +
      scale_color_manual(values=c("black","red")) +
      geom_smooth(data=onsetdata, aes(x=rndLat,y=yralt.resid),  method="lm", linetype=onsetline, color=onsetcolor, fill=onsetcolor) + 
      #geom_smooth(data=termdata, formula = str(fric.term.resid$call), method="lm", linetype=termline, color=termcolor, fill=termcolor) + 
      theme_light() +   theme(legend.position="none") + 
      theme(axis.title=element_text(size=10), plot.margin = margin(t2, m0, b2,m0, "cm")) +
      labs(x="Latitudinal Band", y="Residuals from Onset regressions",title="")
     #The full plot
    sup1b[[rowi]] <- ggplot(onsetdata, aes(x=rndLat, y=yralt.resid)) +
      geom_point(data=onsetdata,aes(x=rndLat, y=yralt.resid, color=as.factor(Group)), shape=24) +
      geom_point(data=filter(onsetdata, Group==1),aes(x=rndLat, y=yralt.resid, color=as.factor(Group)), fill="red",shape=24) +             geom_point(data=termdata,aes(x=rndLat, y=yralt.resid, color=as.factor(Group)), shape=25) +
      geom_point(data=filter(termdata, Group==1),aes(x=rndLat, y=yralt.resid, color=as.factor(Group)), fill="red",shape=25) +
      scale_color_manual(values=c("black","red")) +
      geom_smooth(data=onsetdata, aes(x=rndLat,y=yralt.resid),  method="lm", linetype=onsetline, color=onsetcolor, fill=onsetcolor) + 
      geom_smooth(data=termdata, aes(x=rndLat,y=yralt.resid), method="lm", linetype=termline, color=termcolor, fill=termcolor) + 
      theme_light() +   theme(legend.position="none") + 
      theme(axis.title=element_text(size=10), plot.margin = margin(t2, m0, b2,m0, "cm")) +
      ylim(-100,300) +
      labs(x="Latitudinal Band", title="") + 
        # Custom the Y scales & Add a second axis and specify its features
  scale_y_continuous(name = "Onset Phenology Shift",
    sec.axis = sec_axis( trans=~.-200, name="Termination Phenology Shift"))

}


#################### SUPPLEMENTAL FIGURE 2 COL 1-2: 
##Col 3: Reanalysis: DOY ~ latitude + year, displaying latitude results

sup1c<-list()
for(rowi in 1:nrow(datasets)) {
    #Filter reanalysis data
  pheno.rowi<-pheno.data %>%
    filter(name==datasets$name[rowi], region==datasets$region[rowi], onset>29) 
  #model  for onset
  onset.model<-lm(onset~rndLat+year, data=pheno.rowi)   
  #model for termination
  term.model<-lm(term~rndLat+year, data=pheno.rowi)   
    
  onset.params<-filter(onset1,name==datasets$name[rowi], region==datasets$region[rowi],param=="rndLat",metric=="onset")
  term.params<-filter(term1,name==datasets$name[rowi], region==datasets$region[rowi],param=="rndLat",metric=="termination")

    #set parameters based on LM results 
    onsetline<-ifelse(onset.params$param.p<0.05,"dashed","dotted")
    onsetcolor<-ifelse(onset.params$param.p<0.05,ifelse(onset.params$param.est>0,posslope,negslope),flatslope)

    termline<-ifelse(term.params$param.p<0.05,"dashed","dotted")
    termcolor<-ifelse(term.params$param.p<0.05,ifelse(term.params$param.est>0,posslope,negslope),flatslope)

    #Set top and bottom margins for odd (top of page) and even (bottom of page) rows
    t3<-ifelse((rowi %% 2) == 0,0.5,2.8)
    b3<-ifelse((rowi %% 2) == 0,2.8,0.5)
    
    #Create plot
    
    sup1c[[rowi]] <- ggplot(pheno.rowi, aes(x=rndLat, y=onset)) + 
      geom_point(data=pheno.rowi,aes(x=rndLat, y=onset),shape=24) +              geom_point(data=pheno.rowi,aes(x=rndLat, y=term),shape=25) +      
      geom_smooth(data=pheno.rowi, aes(x=rndLat, y=onset),  method="lm", linetype=onsetline, color=onsetcolor, fill=onsetcolor) + 
      geom_smooth(data=pheno.rowi, aes(x=rndLat, y=term), method="lm", linetype=termline, color=termcolor, fill=termcolor) +
      theme_light() +   theme(legend.position="none") + 
      ylim(30,330) + xlim(50,70) +
      theme(plot.title = element_text(size=11,face = "italic"), axis.title=element_text(size=10), plot.margin = margin(t3, 2, b3, m0, "cm")) +
      labs(x="Latitudinal Band", y="Day of Year (DOY)", title="")
      #For the published figure, we used these geom_smooths. Here they have been commented out because they cause many messages such as:  language lm(formula = onset ~ rndLat, data = onsetdata); language lm(formula = term ~ rndLat, data = termdata)
      #This change does not affect the final figure.
      #geom_smooth(data=pheno.rowi, formula = str(onset.model$call), aes(x=rndLat, y=onset),  method="lm", linetype=onsetline, color=onsetcolor, fill=onsetcolor) + 
      #geom_smooth(data=pheno.rowi, formula = str(term.model$call),  aes(x=rndLat, y=term), method="lm", linetype=termline, color=termcolor, fill=termcolor) + 
}

```
<h2>*</h2>
A small break between creating the panels and assmembling Supplemental Figure 1.
The chunk below combines the panels into Supplemental Figure 1.
```{r combining panels for SF1, warning=F, fig.height = 7, fig.width = 10, fig.align = "center"}

#### COMBINE PANELS FOR SUPPLEMENTAL FIGURE 1
(p1<-grid.arrange(sup1a[[1]],sup1b[[1]],sup1c[[1]],sup1a[[2]],sup1b[[2]],sup1c[[2]],nrow = 2))
(p2<-grid.arrange(sup1a[[3]],sup1b[[3]],sup1c[[3]],sup1a[[4]],sup1b[[4]],sup1c[[4]],nrow = 2))
(p3<-grid.arrange(sup1a[[5]],sup1b[[5]],sup1c[[5]],sup1a[[6]],sup1b[[6]],sup1c[[6]],nrow = 2))
(p4<-grid.arrange(sup1a[[7]],sup1b[[7]],sup1c[[7]],sup1a[[8]],sup1b[[8]],sup1c[[8]],nrow = 2))
(p5<-grid.arrange(sup1a[[9]],sup1b[[9]],sup1c[[9]],sup1a[[10]],sup1b[[10]],sup1c[[10]],nrow = 2))
(p6<-grid.arrange(sup1a[[11]],sup1b[[11]],sup1c[[11]],sup1a[[12]],sup1b[[12]],sup1c[[12]],nrow = 2))
(p7<-grid.arrange(sup1a[[13]],sup1b[[13]],sup1c[[13]],sup1a[[14]],sup1b[[14]],sup1c[[14]],nrow = 2))
(p8<-grid.arrange(sup1a[[15]],sup1b[[15]],sup1c[[15]],sup1a[[16]],sup1b[[16]],sup1c[[16]],nrow = 2))
(p9<-grid.arrange(sup1a[[17]],sup1b[[17]],sup1c[[17]],sup1a[[18]],sup1b[[18]],sup1c[[18]],nrow = 2))
(p10<-grid.arrange(sup1a[[19]],sup1b[[19]],sup1c[[19]],sup1a[[20]],sup1b[[20]],sup1c[[20]],nrow = 2))
(p11<-grid.arrange(sup1a[[21]],sup1b[[21]],sup1c[[21]],sup1a[[22]],sup1b[[22]],sup1c[[22]],nrow = 2))

##### END SUP FIG 1

```
<h2>*</h2>
<p>Below is the code used to create Supplemental Figure 1 in R, for documentation.  </p>
We hope to add a live link to View Supplemental Figure 1 pdf.

```{r complete supplemental figure 1}
#library(ggpubr)
#This code chunk adds the caption information for Supplemental Figure 1 and creates PDF output.

### ADD TITLE & CAPTION TEXT to SF1
#text1<-paste("Larsen and Shirey 2020 Supplemental Figure 1")
#text2<-paste("These panels display the data and regression results for onset and termination across models. Each row of 3 panels represents a",
#            "species in the re-analysis. In the left column, all raw occurrence data are shown as plus symbols' while onset and termination  ",
#            "are shown as diamonds; red points indicate individual observations used as both onset and termination. Fric et al.’s single     ",
#            "regression results of DOY ~ latitude for onset and termination are overlaid on the data. In the middle column, the residuals    ",
#            "used in the Fric et al. (2020) regression of residuals are shown for onset (upward triangle) and termination (downward triangle)",
#            "respectively, with red indicating records of observations used as both onset and termination. Because each dataset is residuals,",
#            "the 'phenology shift' data are centered around 0 and the termination axis is shifted for easier interpretation. The slopes      ",
#            "display the regression of residuals results from Fric et al. (2020). The right column shows the calculated onset  (upward       ",
#            "triangle) and termination (downward triangle) phenometrics calculated using the phest package in R. (Multiple observations for  ",
#            "a latitudinal band represent different years), with the results from the multiple regression reanalysis. For all panels, the    ",
#            "line format demonstrates positive (green, dashed), non-significant (black, dotted), or negative (blue, dashed) correlations with",
#            "latitude in the corresponding models. While the Fric et al. analyses were generally reproducible, significance coding matches   ",
#            "that reported in Fric et al. ST2, rather than our reproduction. We were unable to reproduce p values < 0.05 for the following   ",
#            "single regression analyses: E. maturna onset and L. virgaureae termination.",sep=" \n ")


#spaces<-paste(" ")
#tg <- text_grob(text1, just="centre",size=18)
#th <- text_grob(text2, just="left",size=10)
#ts <- text_grob(spaces, size=40)
#lay <- rbind(c(1,1,1),c(2,NA,NA),c(3,4,5))


###  SUPP FIG 1  
#p0<-grid.arrange(tg,th,ts,nrow = 3,layout_matrix = lay, heights=c(1,2,3))
#SF1<-grid.arrange(p0,p1,p2,p3,p4,p5,p6,p7,p8,p9,p10,p11, nrow=12)

#pdf("outputs/Larsen_Shirey2020_SuppFigure1.pdf", width=11, height=8.5)
#p0; p1; p2; p3; p4; p5; p6; p7; p8; p9; p10; p11
#dev.off()
```
This is the end of this analysis. 

Author notes - Future updates should:
Remove variables when we're done with them
See if we can suppress geom_smooth() messages
