---
title: "Fric et al. Re-analysis Code"
author: "Vaughn Shirey & Elise Larsen"
date: "3/9/2020"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# load libraries
library(tidyverse); library(ggplot2); library(grid)

```

#### Data Exploration
Here we explore the data used in Fric et al. (2020)

##### Data Formatting
Datasets are not formatted as a single data table; individual datasets were all written into one data file, including headers and row indices in each dataset. This first set of code reformats the data & writes formatted data files. 

```{r}
all.data <- readLines("fric_supplements/data.csv")

#identify header rows
all.header.rows<-grep("decimalLongitude", all.data)
#check headers for consistency
unique(all.data[all.header.rows])
# 2 versions!
header.rows1<-grep('country\",\"day', all.data)
header.rows2<-setdiff(all.header.rows, header.rows1)

#need to add a row index to the header text for new data files
header1<-paste('"row.index\",' ,all.data[1], sep="")
header2<-paste('"row.index\",' ,all.data[header.rows2[1]], sep="")

#Create row index: 0 is a header row, 1 is format 1 data, 2 is format 2 data
j<-rep(0,length(all.data))
for (i in header.rows1) {
  next_index<-ifelse(length(header.rows2[header.rows2>i])>0,min(header.rows2[header.rows2>i]),length(all.data))
  j[(i+1):(next_index-1)]<-1
}
for (i in header.rows2) {
  next_index<-ifelse(length(header.rows1[header.rows1>i])>0,min(header.rows1[header.rows1>i]),length(all.data))
  j[(i+1):(next_index-1)]<-2
}
j[all.header.rows]<-0

#write data files
formatteddatafile1<-file("fric_data_format1.txt")
writeLines(c(header1,all.data[j==1]), formatteddatafile1)
close(formatteddatafile1)

formatteddatafile2<-file("fric_data_format2.txt")
writeLines(c(header2,all.data[j==2]), formatteddatafile2)
close(formatteddatafile2)
rm(list=ls())
```
#### Data exploration
This set of code assigns regions to data based on Longitude and summarizes the data.

```{r}
#read back in the formatted data
data1<-read_csv("fric_data_formatted1.txt")
data2<-read_csv("fric_data_formatted2.txt")
paste( nrow(data1), "records in format 1;", nrow(data2), "records in format 2")

occur<-rbind(data1,data2)
rm(list=ls(data1,data2))
## plot records by longitude
hist(occur$decimalLongitude, main="Data density by Longitude") 
#ID records by region
occur<-occur %>% 
  mutate(region=ifelse(decimalLongitude>=(-40),"Europe","N. America"))
```

#### Data Exploration
Next we do a basic exploration of the data and summarize data by species and region (dataset)
This set of code outputs a csv with the quantitative columns of Supplemental Table 1

```{r}
#Begin exploration of data used in Fric et al. (2020)
summary(occur)

#Tally the number of observations per dataset & calculate how each dataset spans latitude, year, altitude
spans.summary<-occur %>%
  group_by(name, region) %>%
  add_count(name="fric_n") %>% ## n. records
  group_by(name, region, fric_n) %>%
  summarize(lat_span=(max(rndLat, na.rm=T)-min(rndLat, na.rm=T)), 
         year_span=(max(year, na.rm=T)-min(year, na.rm=T)),
         alt_span=round((max(alt, na.rm=T)-min(alt, na.rm=T)),0))

#calculate # latitudes, onsets, terminations, flight curves = 0
endpt.summary<-occur %>%
  group_by(name, region, rndLat) %>%
  add_count(name="n_recs") %>% # n. records by latitudinal band
  filter(SuccDay==min(SuccDay) | SuccDay==max(SuccDay)) %>%
  mutate(onset=ifelse(SuccDay==min(SuccDay),1,0), term=ifelse(SuccDay==max(SuccDay),1,0)) %>%
  group_by(name, region) %>%
  summarize(n_lat=length(unique(rndLat)), n_onset=sum(onset), n_term=sum(term), n_flightcurve0s=sum(n_recs==1) )

#combine summary tables
fric.data.summary<-merge(spans.summary, endpt.summary, by=intersect(names(spans.summary), names(endpt.summary)))


#Summarize data availability for Larsen & Shirey re-analysis
#Now, filter data for altitude & for cases with1 0 or more records by species-region-year-latitude
new.data.summary<-occur %>%
  filter(alt>=0, alt<=500) %>%
  group_by(name, region, rndLat, year) %>% # phenometrics by species, region, latitude & year
  add_count(name="group_n") %>% ## n. observations per sp-yr-lat-region
  filter(group_n>=10) %>% ### phenometrics only if 10 or more obs.
  group_by(name, region) %>%
  add_count(name="our_n_obs") %>% ## n obs in our filter
  group_by(name, region, our_n_obs) %>%
  summarize(our_n_lat=length(unique(rndLat)), our_n_fcurve=length(unique(paste(rndLat,year))), 
            our_lat_span=(max(rndLat, na.rm=T)-min(rndLat, na.rm=T)), 
            our_year_span=(max(year, na.rm=T)-min(year, na.rm=T)),
            our_alt_span=round((max(alt, na.rm=T)-min(alt, na.rm=T)),0))

#combine summary tables
supptable1<-merge(fric.data.summary, new.data.summary, by=intersect(names(fric.data.summary), names(new.data.summary)), all.x=T)
head(supptable1)

#output summary table to csv file
write_csv(supptable1, "supp_table1.csv")

```

#### Explore data by altitude & latitude
##### Create Figure 1: Occurrences by altitude & latitude 
This figure uses 4 species selected by Fric et al. and 2 additional species selected by Larsen & Shirey

```{r}
#species lists
fric.sp<-c("Agriades glandon","Glaucopsyche lygdamus","Hesperia comma","Parnassius smintheus")
fig1sp<-c(fric.sp,"Anthocharis cardamines","Colias canadensis")

#Filter data to these species
data_filt<-occur %>%
  filter(name %in% fig1sp)  

#Get onset & termination dates (SuccDay)
onset.d<-data_filt %>%
  group_by(name, region, rndLat) %>%
  mutate(onset=min(SuccDay), term=max(SuccDay), fp=term-onset) %>%
  filter(onset == SuccDay | term == SuccDay)

#summarize datasets
(datasets<-data_filt %>%
    group_by(name, region) %>%
    tally())

temp2<-list()
#Dataset order for figure 1 - prints by rows
ds1<-c(1,4,5,7,2,3)  # (1,5,2,4,7,3) for marrangeGrob - by columns
panels<-c("A","E","F","B","C","","D","","","")
### Plots with color by year and symbol by phenometric
for (dset in 1:nrow(datasets)) {
  sp<-datasets$name[dset]
  reg<-datasets$region[dset]
  plottitle<- bquote(italic(.(sp)) ~ "-"~ .(reg))
  plot.i<-ggplot(data=filter(data_filt,name==sp, region==reg), aes(x=decimalLatitude, y=alt, color=year)) +
    theme_light() + theme(legend.position = "none") + 
    xlim(30,72) + ylim(-400,4200) + labs(x = "Latitude", y = "Altitude", tag=panels[dset]) + 
    geom_point(data=filter(data_filt,name==sp, region==reg), aes(x=decimalLatitude, y=alt, color=year),shape=3) + 
    geom_point(data=filter(onset.d,name==sp, region==reg), aes(x=decimalLatitude, y=alt, color=year), shape=22, size=3) + 
    geom_point(data=filter(onset.d,name==sp, region==reg, fp==0), aes(x=decimalLatitude, y=alt, color=year), shape=15, size=3) + 
    scale_colour_gradient(low="red",high="black", limits=c(1850,2015)) + #, limits=c(min(data_filt$year), max(data_filt$year))) +
    scale_fill_gradient2(low="white", high="black", limits=c(min(onset.d$fp), max(onset.d$fp))) +
    geom_point(data=filter(onset.d,name==sp, region==reg), aes(x=rndLat, y=-400, fill=fp),shape=21, size=2) + 
    #geom_point(data=filter(onset.d,name==sp, region==reg), aes(x=decimalLatitude, y=alt, color=year), shape=22, size=2) + 
    ggtitle(plottitle)
    temp2[[dset]]<-plot.i
    if(dset %in% ds1) print(plot.i)
}

#Figure 1
#arrangeGrob(grobs=temp2[ds1], nrow=3, ncol=2)
pdf_filename<-("LarsenShirey2020_Fig1.pdf")
ggsave(pdf_filename, arrangeGrob(grobs=temp2[ds1], nrow=3, ncol=2), width=8, height=10, units="in")

```

#This is the end of Elise's current R markdown clean file







#### Re-analysis
Data were insufficient for North American datasets, so we selected European species with sufficient data for re-analysis.
```{r}
univoltine<-c("Aphantopus hyperantus","Argynnis aglaja","Argynnis niobe","Argynnis paphia","Aricia artaxerxes",
              "Boloria aquilonaris","Brenthis ino","Colias palaeno","Erebia ligea",
              "Euphydryas aurinia","Euphydryas maturna","Fabriciana adippe",
              "Carterocephalus palaemon","Hesperia comma","Limenitis populi",
              "Lycaena hippothoe","Lycaena virgaureae","Maniola jurtina")

data_filt<-occur %>%
  filter(name %in% univoltine, region=="Europe", alt>=0, alt<=500) 

#calculate data density for each dataset in reanalysis
datasets<-data_filt %>%
  group_by(name, region) %>%
  tally()

#and data density by latitude
data_filt2<-data_filt %>%
  group_by(name, region, rndLat) %>%
  tally() 

data1<-merge(data_filt,data_filt2,by=intersect(names(data_filt),names(data_filt2)))
onsets<-data_filt %>%
  group_by(name, region, rndLat) %>%
  summarize(onset=min(SuccDay), term=max(SuccDay))
onset.d<-merge(onsets, data_filt,by=intersect(names(onsets),names(data_filt)))
onset.d<- onset.d %>%
  filter(onset == SuccDay | term == SuccDay)
